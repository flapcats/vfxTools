import maya.cmds as cmds
import subprocess

"""
import autoSED
reload(autoSED)

autoSED.doSomething()


"""

def doSomething():

    def autoSED(filePath,searchFor,replaceWith):
        
        # Formatting to separate directory and filename
        niceFilePath = filePath[3:-2]
        splitPath = niceFilePath.split("/")
        fileName = splitPath[-1]
        splitDirectory = niceFilePath.split("/")
        justFilePath = splitDirectory[:-1]
        fileDirectory = "/".join(map(str,justFilePath))
        
        # Safety check to ensure the file is in projects isn't being searched
        if (filePath == False) or ("/mnt/projects/" not in filePath):
            print "\nERROR: File is not in a project directory.",
        
        else:
            print "doing the thing"
            # Create the command for the terminal
            command1 = "cd " + fileDirectory
            command2 = "find . -name '"+ fileName +"' -exec sed -i 's!"+searchFor+"!"+replaceWith+"!g' '{}' \;"
            #command1 = "find . -name '"+ niceFilePath +"' -exec sed -i 's!"+searchFor+"!"+replaceWith+"!g' '{}' \;"
            
            finalCommand = command1 + " && " + command2
            print "Command being passed to the terminal: ", finalCommand
        
            # Pass the commands to a shell
            subprocess.Popen(finalCommand, shell=True)
            print "Auto-SED complete for file: %s" % fileName,
            
            
    
    def createWindow():
        windowID = 'window'
        if cmds.window(windowID, exists = True):
            cmds.deleteUI('window')
        window = cmds.window(windowID)
        cmds.rowColumnLayout()
        cmds.textFieldGrp('searchFor', label = 'Search for: ')
        cmds.textFieldGrp('replaceWith', label = 'Replace with: ' )
        #cmds.button(label = 'pass textfield values', command = queryTextField)
        cmds.button( label='Search and Replace', command=('queryTextField(searchFor,replaceWith);cmds.deleteUI(\"' + window + '\", window=True)') )
        cmds.showWindow( window )
    
    def queryTextField(searchFor,replaceWith):
        searchFor = cmds.textFieldGrp( 'searchFor', query = True, text = True)
        replaceWith = cmds.textFieldGrp( 'replaceWith', query = True, text = True)
        doit = cmds.confirmDialog(m="Search and replace?\n\n{}\n\nfor\n\n{}\n\nThis is not undoable.".format(searchFor,replaceWith), b=["OK","Cancel"], icn="warning", ma="center", t="autoSED")
        if doit == 'OK':
            print "Searching {} for: {}. Replacing with: {}".format(filePath[3:-2],searchFor,replaceWith),
            autoSED(filePath,searchFor,replaceWith)
    
    
    #------ code here ------
    
    searchFor = ""
    replaceWith = ""    
    fileFilter = "Maya Files (*.ma *.mb);;Maya ASCII (*.ma);;Maya Binary (*.mb);;All Files (*.*)"
    filePath = str(cmds.fileDialog2(ds=2, cap="Choose a file to search & replace through.", ff=fileFilter, fm=1, okc="This file", cc="Cancel"))
    createWindow()


